# Web 通信之长连接、长轮询

轮询、长轮询、长连接、websocket

## 轮询

短轮询一般是指每隔一段时间客户端向服务器发送 Http 请求，服务器在接收请求后，返回对应的响应数据。

这种方式实现相对简单，容易理解。缺点也比较明显，**频繁的发送请求**，**严重浪费客户端和服务器资源**。如果客户端用户越多，服务器端压力越大。

```js
var xhr = new XMLHttpRequest();

setInterval(function () {
  xhr.open("GET", "/");
  xhr.onreadystatechange = function () {
    // do something
  };
  xhr.send();
}, 3000);
```

## 长轮询（comet）

单服务器收到客户端请求后，服务器不会直接进行响应，而是将请求挂起，然后判断服务器端数据是否有更新，如果有更新，则返回响应结果，如果没有数据，则达到一定时间限制（服务器设置）才会返回。客户端获取到响应数据后，可以再次发送请求，重新建立连接。

长轮询相对短轮询对比，明显**减少 http 请求次数**，节约资源，长轮询确定在于，连接挂起也回导致**资源浪费**。

> 轮询与长轮询都是**基于 HTTP 的**，两者本身存在着缺陷：轮询需要更快的处理速度；长轮询则更要求处理并发的能力；两者都是“被动型服务器”的体现:服务器不会主动推送信息，而是在客户端发送 ajax 请求后进行返回的响应。而理想的模型是"在服务器端数据有了变化后，可以主动推送给客户端",这种"主动型"服务器是解决这类问题的很好的方案。Web Sockets 就是这样的方案。

## 长连接（SSE）

SSE 是 HTML5 新增的功能，全称为 Server-Sent Events。它可以允许服务推送数据到客户端。SSE 在本质上就与之前的长轮询、短轮询不同，虽然都是基于 http 协议的，但是轮询需要客户端先发送请求。而 SSE 最大的特点就是不需要客户端发送请求，可以实现只要服务器端数据有更新，就可以马上发送到客户端。

SSE 的优势很明显，它不需要建立或保持大量的客户端发往服务器端的请求，节约了很多资源，提升应用性能。并且后面会介绍道，SSE 的实现非常简单，并且不需要依赖其他插件。

## WebSocket

WebSocket 是 Html5 定义的一个新协议，与传统的 http 协议不同，该协议可以实现服务器与客户端之间全双工通信。简单来说，首先需要在客户端和服务器端建立起一个连接，这部分需要 http。连接一旦建立，客户端和服务器端就处于平等的地位，可以相互发送数据，不存在请求和响应的区别。

WebSocket 的优点是实现了双向通信，缺点是服务器端的逻辑非常复杂。现在针对不同的后台语言有不同的插件可以使用。

## 四种 Web 即时通信技术比较

从兼容性角度考虑，短轮询>长轮询>长连接 SSE>WebSocket；

从性能方面考虑，WebSocket>长连接 SSE>长轮询>短轮询。
